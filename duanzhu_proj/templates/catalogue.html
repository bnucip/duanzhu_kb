<div id="tree-container"></div>
<script>
$(document).ready(function() {
    var bushou = "{{zitou.bushou}}";
    var zitouid = "{{zitou.id}}"
    console.log(zitouid);
    $('#tree-container').jstree({
        'core': {
            'data': {
                "url": "/catalogue/",
                "dataType": "json",
                "error": function(jqXHR, textStatus, errorThrown) {
                    console.error("AJAX Error:", textStatus, errorThrown);
                    alert("Error loading data. Please try again.");
                }
            },
            'check_callback': true
        },
        'types': {
            'juan': { 'icon': false },
            'bushou': { 'icon': false },
            'zitou': { 'icon': false }
        },
        'plugins': ["types"]
    }).on('loaded.jstree',function(e,data){
        $('#tree-container').jstree('select_node', bushou, true);
        //$('#tree-container').jstree('deselect_node', '一', true);
    }).on('activate_node.jstree', function (e, data) {
        var node = data.node; // 获取被激活的节点数据
        if (node) { // 确保节点存在
            $('#tree-container').jstree(true).toggle_node(node); // 切换节点的展开状态
        }
    });


    $('#tree-container').on("select_node.jstree", function (e, data) {
        let node = data.node;

        // Ensure node.data exists
        if (!node.data) {
            node.data = {};  // Initialize node.data if undefined
        }

        // If a Bushou is clicked, load Zitous
        if (node.type === "bushou" && !node.data.loaded) {
            node.data.loaded = true;  // Prevent duplicate requests

            $.ajax({
                url: "/catalogue/?bushou=" + node.id,
                type: "GET",
                dataType: "json",
                success: function(zitous) {
                    zitous.forEach(z => {
                        $('#tree-container').jstree().create_node(node, z);
                        //console.log(z);
                        if(z.id==zitouid){
                            $('#tree-container').jstree('select_node', z.id, true);
                            $('#tree-container').jstree('deselect_node', bushou, true);
                        }
                    });
                    $('#tree-container').jstree().open_node(node);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Failed to load zitous:", textStatus, errorThrown);
                    alert("Failed to load zitous. Try again.");
                    node.data.loaded = false;  // Allow retry on failure
                }
            });
        }

        // When a Zitou node is clicked, only refresh the main block
        else if (node.type === "zitou") {
            const zstag = $("#zstag").val();
            // Load the zitou content into the main block only, prevent left block refresh
            $('#main').load("/zitou/" + node.id + "/", function(response, status, xhr) {
                if (status === "error") {
                    console.error("Failed to load content:", xhr.statusText);
                    alert("Error loading content.");
                }
                $(".zstag").show();
                if(zstag){
                    loadZsTag(node.id,zstag);
                    $("#zstag").val(zstag);
                }else{
                    loadZsTag(node.id,'xg');
                    $("#zstag").val('xg');
                }
            });
        }
    });
});
</script>
